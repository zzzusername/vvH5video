<template>
	<div id="videoshare" class="mRight">
		<div class="videoshareList">
			<div class="zForm">
				<span class="paddingLeft">创建人姓名或手机号：</span>
                <input class="zInput" type="text" placeholder="请输入姓名或手机号" v-model="creator_name_or_phonenum" />
                <span class="paddingLeft">状态：</span>
                <div class="zSelect">
                    <el-select v-model="checkValue" class="zgroup" placeholder="--请选择--">
                        <el-option v-for="item in checkData" 
                        :key="item.index" :label="item.description" :value="item.value"></el-option>
                    </el-select>
                </div>
                <button class="buttonradius" @click="findData">查询</button>
                <button class="buttonradius" @click="clearData">清空</button>
			</div>
			<!-- table  -->
			<div class="zTable">
				<div class="elTable">
					<div class="scrollbox">
						<el-table
						:data="liveTabledata"
						>
							<el-table-column prop="fixedSort" label="序号"></el-table-column>
							<el-table-column prop="title" label="直播主题"></el-table-column>
							<el-table-column prop="start_time" label="直播开始时间">
                                <template slot-scope="scope">
									<span>{{ scope.row.start_time | FormatDate('yyyy-MM-dd hh:mm:ss') }}</span>
								</template>
                            </el-table-column>
							<el-table-column prop="duration" label="直播时长/分钟"></el-table-column>
							<el-table-column prop="creator_name" label="创建人"></el-table-column>
							<el-table-column prop="creator_phonenum" label="创建人手机号"></el-table-column>
							<el-table-column prop="status_description" label="状态"></el-table-column>
							<el-table-column prop="createtime" label="创建时间">
                                <template slot-scope="scope">
									<span>{{ scope.row.createtime | FormatDate('yyyy-MM-dd hh:mm:ss') }}</span>
								</template>
                            </el-table-column>
							<el-table-column prop="" label="操作">
								<template slot-scope="scope">
									<span class="spanBtn" v-if='scope.row.status == "PLAYING"' @click="liveStop(scope.row)">直播终止</span>
									<span class="spanBtn" v-if='scope.row.status != "PLAYING" ' @click="liveDelete(scope.row)">删除</span>
									<span class="spanBtn" @click="getLivedetail(scope.row)">详情</span>
								</template>
							</el-table-column>
						</el-table>
					</div>
                    <!-- page -->
                   	<el-pagination
						@current-change="handleCurrentChange" 
						:current-page.sync="page_total_pages" 
						:page-size="page_size" 
						layout="total, prev, pager, next, jumper" 
						:total="page_total_items"
						class="zPage"
						>
					</el-pagination>
				</div>
			</div>
		</div>
        <!-- 详情弹窗 -->
		<el-dialog  title="查看详情" 
			:visible.sync="detailPop"
			id="zDialogtext"
		 	width="30%">
			<div class="block">
				<li>
					<span class="liL">直播主题</span>
					<span class="liR">{{detailData.title}}</span>
				</li>
				<li>
					<span class="liL">直播开始时间</span>
					<span class="liR">{{detailData.createtime  | FormatDate('yyyy-MM-dd hh:mm:ss') }}</span>
				</li>
				<li>
					<span class="liL">直播时长/分钟</span>
					<span class="liR">{{detailData.creator_phonenum}}</span>
				</li>
                <li>
					<span class="liL">发布人</span>
					<span class="liR">{{detailData.creator_name}}</span>
				</li>
                <li>
					<span class="liL">发布人手机</span>
					<span class="liR">{{detailData.creator_phonenum}}</span>
				</li>
                <li>
					<span class="liL">直播方式</span>
					<span class="liR">{{detailData.type}}</span>
				</li>
                <li>
					<span class="liL">直播状态</span>
					<span class="liR">{{detailData.status}}</span>
				</li>
                <li>
					<span class="liL">创建时间</span>
					<span class="liR">{{detailData.start_time  | FormatDate('yyyy-MM-dd hh:mm:ss')}}</span>
				</li>
                <li>
					<span class="liL">直播简介</span>
					<span class="liR">{{detailData.content}}</span>
				</li>
                <li class="liveWord" v-if='detailDatafilePata'>
					<span class="liL">直播文档</span>
                    <ul class="liR">
                        <li v-for="item in detailDatafilePata" :key="item.key">
                            <span>{{item.fileName}}</span>
                            <!-- <span class="upDownload" @click="upDown(item.filePath)">下载</span> -->
                            <a class="upDownload" :href="upDown(item.filePath)" download="item.fileName.txt">下载</a>
                        </li>
                    </ul>
				</li>
                <li v-if='detailData.operation'>
					<span class="liL">操作</span>
					<span class="liR">{{detailData.operation}}</span>
				</li>
                <li v-if='detailData.operator'>
					<span class="liL">操作人</span>
					<span class="liR">{{detailData.operator}}</span>
				</li>
                <li v-if='detailData.operation_time'>
					<span class="liL">操作时间</span>
					<span class="liR">{{detailData.operation_time | FormatDate('yyyy-MM-dd hh:mm:ss')}}</span>
				</li>
			</div>
			<div class="userBtn">
				<el-button size="small" @click="detailPop = false">关闭</el-button>
			</div>
		</el-dialog>
	</div>
</template>
<script>
	import $ from "jquery";
    import axios from "axios";
    /* 展示弹窗样式文件 */
    import '../../style/common.css' /*引入公共样式*/
	// js
    import {heightAuto,getCaption} from '../../untils/heightAuto' //注意路径
    
    /* api */
    import {
            liveVideolist,
            livevVideodelete,
            liveVideoget,
            listAllstatus,
            liveVideostop,
            } from '../../api/videomanagement'

	export default {
        data() {
			return {
                creator_name_or_phonenum : '',
                /* 审核搜索数据 */
                checkValue : '',
                checkData : [],
                // 表格数据
				liveTabledata : [
					/* {
                        "id": "63fabab5-eeae-480d-94cd-c61514b6ad13",
                        "title": "直播频道测试",
                        "start_time": 1566298800000,
                        "duration": 60,
                        "creator_name": "田力心",
                        "creator_phonenum": "18510060534",
                        "status": "APPOINT",
                        "status_description": "未开始",
                        "createtime": 1566295478000
                    }, */
                ],
                detailPop : false,
                // 详情数据集合
                detailData : {},              
                detailDatafilePata : [],
				/* 分页相关 */
				page_size : 10,			//  请求多少条目
				page_total_items : 10,  // 总条数
				page_total_pages : 1,  //  当前条数
			}
		},
		mounted: function() {
			let row = '.videoshareList'
            heightAuto(row)
            // 初始化直播列表
            this.getInitdata();
            // 初始化下啦状态
            this.getInitState();
		},
		methods:{
            // 初始化数据
            getInitdata(){
                let objData = {
                    "enterprise_id": localStorage.EnterpriseId,
                    "page_number": this.page_total_pages - 1,
                    "page_size": this.page_size,
                }
                // name 
                if(this.creator_name_or_phonenum != ''){
                    objData.creator_name_or_phonenum = this.creator_name_or_phonenum;
                }
                // 状态
                if(this.checkValue != ''){
                    objData.status = this.checkValue;
                }
                liveVideolist(objData).then(res => {
					if (res.status === 200 && res.data.result == "ok") {
                        this.liveTabledata = res.data.data.list;
                        // 序号
						this.liveTabledata.map(function(item,index){
							item.fixedSort = index - 0 + 1;
						})
						/* 总条数 */
						this.page_total_items = res.data.data.page_total_items; 
						this.page_total_pages = res.data.data.page_number - 0 + 1;
					}
				});	
            },
            // 下拉状态
            getInitState(){
                listAllstatus({}).then(res => {
					if (res.status === 200 && res.data.result == "ok") {
                        this.checkData = res.data.data;
					}
				});	             
            },
            findData(){
				this.page_total_pages = 1;
                this.getInitdata();
            },
            clearData(){
                this.creator_name_or_phonenum = '';
				this.checkValue = '';
				this.page_total_pages = 1;
                this.getInitdata();
            },
            liveStop(scope){
				let objData = {
					"live_video_id": scope.id,
  					"operator_id": localStorage.userId
                } 
				this.$confirm('是否终止直播?', '提示', {
						confirmButtonText: '确定',
						cancelButtonText: '取消',
						type: 'warning'
					}).then(() => {
						liveVideostop(objData).then(res => {
							if (res.status === 200 && res.data.result == "ok") {
								
								this.$message({
									type: 'success',
									message: '终止成功!'
								});
								// 更新数据
								this.getInitdata();
								
							}else{
								// 错误提示信息
								this.$message.error(res.data.error_description);
							}
						});	
					}).catch(() => {
						this.$message({
							type: 'info',
							message: '已取消终止'
						});          
					});
				
            },
            liveDelete(scope){/* 
                console.log('直播删除')
                console.log(scope) */
                let objData = {
                    "live_video_id": scope.id,
                    "operator_id": localStorage.userId
                } 
                this.$confirm('是否删除?', '提示', {
							confirmButtonText: '确定',
							cancelButtonText: '取消',
							type: 'warning'
						}).then(() => {
							livevVideodelete(objData).then(res => {
								if (res.status === 200 && res.data.result == "ok") {
									
									this.$message({
                                        type: 'success',
                                        message: '删除成功!'
									});
									// 更新数据
									this.getInitdata();
									
								}else{
									// 错误提示信息
									this.$message.error(res.data.error_description);
								}
							});	
						}).catch(() => {
							this.$message({
								type: 'info',
								message: '已取消删除'
							});          
						});

            },
            getLivedetail(scope){
                console.log(scope);
                this.detailPop = true;
                let objData = {
                    "id": scope.id
                } 
                // 获取直播详情
                liveVideoget(objData).then(res => {
                    if (res.status === 200 && res.data.result == "ok") {
                        this.detailData =  res.data.data;
                        this.detailDatafilePata =  res.data.data.file;
						this.$nextTick(() => {
							this.detailPop = true;
						});
						  
                    }else{
                        // 错误提示信息
                        this.$message.error(res.data.error_description);
                    }
                });	
            },
            upDown(path){
                // 下载
                let str = '/upload';
                let obj = path
                let imgUrl = getCaption(obj,str)         
                return imgUrl;
            },
            // page
			handleCurrentChange(currentPage) {
				this.page_total_pages = currentPage;
				this.getInitdata();
			},
        },
        updated() {
			/* var addmodHei = $("#userAddModel2 .el-dialog").height();
			$("#userAddModel2 .el-dialog").css("marginTop", -(addmodHei / 2));
			$("#userAddModel2 .el-dialog").css("marginBottom", 0);
			$("#distributionModel2 .el-dialog").css("marginTop", "-297px"); */
		}
	}
	
</script>
<style scoped>
.liveWord .liL,.liveWord .liR{
    height: 150px;
}
.liveWord .liR .upDownload{
    display: inline-block;
    color: #333;
    text-align: center;
    box-sizing: border-box;
    margin-left: 10px;
    font-size: 12px;
    background: #fff;
    padding: 5px;
    line-height: 12px;
    border-radius: 3px;
    cursor: pointer;
}
.popInput{
	width: 100%;
    height: 36px;
    font-size: 14px;
    margin-left: 10px;
    line-height: 36px;
    padding-left: 4px !important;
    margin-right: 20px;
    background: #2a3558;
    border: 1px #3b4872 solid;
	text-indent: 1em;
}
.spanBtn{
	cursor: pointer;
	margin: 0 5px;
}
.onlyLine{
    display: inline-block;
    margin-top: 20px;
}
.block{
	width: 100%;
}
</style>

<style lang="scss">
	#videoshare {
		.videoshareList {
			padding: 34px 42px;
			margin: 15px 27px 15px 15px;
			background: #354166;
			box-shadow: 0 0 26px #01060e;
			.zForm {
				span {
					float: left;
					color: #eee;
					display: block;
					font-size: 14px;
					overflow: hidden;
					line-height: 36px;
				}
				button {
					float: left;
					color: #eee;
					height: 38px;
					font-size: 14px;
					margin-left: 11px;
					text-align: center;
					line-height: 38px;
					padding: 0px 15px;
					background: #1b274c;
					border: 1px #3b4872 solid;
				}
				button:hover {
					background: #57e29b;
				}
				span.btnRight {
					float: right;
					display: inline-block;
				}
				.zSelect {
					float: left;
					width: 148px;
				}
				.paddingLeft {
					padding-left: 20px;
				}
				.zInput {
					float: left;
					width: 200px;
					height: 34px;
					font-size: 14px;
					margin-left:10px;
					line-height: 35px;
					padding-left: 4px !important;
					margin-right: 20px;
					background: #2a3558;
					border: 1px #3b4872 solid;
				}
			}
			.zTable {
				clear: both;
				height: 94%;
				overflow: hidden;
				padding-top: 30px;
				.elTable {
					height: 91.7%;
					overflow: hidden;
					.el-table .warning-row td {
						color: oldlace;
						background-color: transparent;
					}
					.el-table .warning-row {
						background: -webkit-linear-gradient(#3f7984, #485b7d, #3f7984);
						background: -o-linear-gradient(#3f7984, #485b7d, #3f7984);
						background: -moz-linear-gradient(#3f7984, #485b7d, #3f7984);
						background: linear-gradient(#3f7984, #485b7d, #3f7984);
						filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#3f7984', endColorstr='#485b7d', GradientType=0);
						border-top: 2px #57e29b solid;
						border-bottom: 2px #57e29b solid;
					}
					.el-table .success-row {
						background-color: #6ee2c1;
						color: #f0f9eb;
					}
					.el-table .warning-row td {
						color: oldlace;
					}
					.el-table .success-row td {
						color: #f0f9eb;
					}
					.el-table .warning-row td div {
						color: oldlace;
					}
					.el-table .success-row td div {
						color: #f0f9eb;
					}
				}
			}
		}
		input.el-input__inner:hover {
			border: 1px #3b4872 solid;
		}
		.el-input__icon {
			width: 37px;
		}
		.el-input--prefix .el-input__inner {
			padding-left: 38px;
		}
	}
	@media screen and (max-width: 1440px) {
		#videoshare {
			.mRightTwo {
				.paddingLeft {
					padding-left: 10px;
				}
				.zForm {
					button {
						height: 30px;
						font-size: 12px !important;
						line-height: 30px;
						padding-left: 8px;
						padding-right: 8px;
					}
					span {
						font-size: 12px !important;
					}
					span.btnRight {
						float: left;
						/*margin-top: 10px;*/
					}
					.zInput {
						width: 100px !important;
						height: 28px;
						line-height: 28px;
					}
					.zgroup {
						height: 30px;
					}
					.zSelect {
						float: left;
						width: 106px;
					}
				}
				.zTable {
					clear: both;
					height: 94%;
					overflow: hidden;
					padding-top: 26px;
					.elTable {
						height: 82%;
						.el-table td {
							padding: 4px 0;
						}
					}
				}
			}
		}
	}
	@media screen and (max-width: 1366px) {
		#videoshare .mRightTwo .el-dialog .el-dialog__body{
			padding: 24px 24px 10px;
		}
		#videoshare {
			.mRightTwo {
				.paddingLeft {
					padding-left: 10px;
				}
				.zForm {
					button {
						height: 30px;
						font-size: 12px !important;
						line-height: 30px;
						padding-left: 5px;
						padding-right: 5px;
					}
					span {
						font-size: 12px !important;
					}
					span.btnRight {
						float: left;
					}
					.zInput {
						width: 80px !important;
						height: 28px;
						line-height: 28px;
					}
					.zgroup {
						height: 30px;
					}
					.zSelect {
						float: left;
						width: 104px;
					}
				}
				.el-select-dropdown__item {
					font-size: 12px;
				}
			}
		}
    }
    /* 弹窗样式重置 */
    .formTable{
        padding: 2px 4px;
        background: #4a567c;
        margin-bottom: 20px;
    }
    .block .el-form-item__label{
        height: 36px;
        margin: 2px 0;
        line-height: 36px;
        border: 1px solid #3b4872;
    }
    #userAddModel2 .el-form-item {
		margin: 0;
		padding: 0;
		float: left;
    }
    .infoMsg{
        padding-left: 9px;
        display: inline-block;
        margin-top: 10px;
    }
    .checkboxBg{
        height: 34px;
        margin: 2px 0;
        line-height: 34px;
        padding-left: 12px;
        background: #2a3558;
        border: 1px solid #3b4872;
        text-align: left;
    }
    .el-dialog .textarea .el-form-item__label{
        height: 160px;
    }
    .textarea{
        clear: both;   
        width: 100%;
        height: 70px;
        background: #4a567c;
        font-size: 14px;
        padding: 10px;
	}
	/* 弹窗样式重置 */
	#userAddModel2 .el-form-item{
		width: 100%;
	}
</style>